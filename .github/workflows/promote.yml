name: Promote Image
on:
  workflow_dispatch: {}
jobs:
  promote-image:
    runs-on: ubuntu-latest
    permissions:
      packages: write
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }}
    steps:
      - uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - run: |
          # github.repository outputs owner/repo_name, but we need just the repo_name in some places.
          export github_repo=$(basename ${{ github.repository }})

          # https://docs.github.com/en/rest/packages/packages?apiVersion=2022-11-28#list-package-versions-for-a-package-owned-by-an-organization
          current_tag=$(curl -s -L -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -H "X-GitHub-Api-Version: 2022-11-28" "https://api.github.com/orgs/${{ github.repository_owner }}/packages/container/${github_repo}/versions" | jq -r '.[].metadata.container.tags[]' | grep -E "^dev-[0-9a-f]{7}-[0-9]+$" | sort -R | sort --field-separator=- -k 3 -r | head -n 1)

          # Using docker pull/push -a because it keeps all the tags together, which looks nicer on ghcr.io.
          docker pull -a \
            "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${current_tag}"
          new_tag=$(echo ${current_tag} | sed -E "s/.*-([^-]+)-([^-]+)/prod-\1-\2/")
          docker tag \
            "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${current_tag}" \
            "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${new_tag}"
          docker push -a \
            "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
